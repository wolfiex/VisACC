<!DOCTYPE html>
<meta charset="utf-8">
<style>
@import url(./src/style.css);
#graphdiv {
  position: absolute;
  left: 0px;
}

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}
.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}
canvas{ position:'absolute'; }
</style>


<script src="./src//d3.v4.min.js"></script>
<script src="./graphfunctions.js"></script>
<script src="./postfunctions.js"></script>
<script src="./src/stats.js"></script>
<link src='./src/fonts'  rel='stylesheet' type='text/css'>
<script src="./src/netcdfjs.min.js"></script>
<!-- href='https://fonts.googleapis.com/css?family=Open+Sans|Lato|Vidaloka|Fira+Sans|Fredericka+the+Great|Ubuntu'
-->

<body>

  <div id="myModal" class="modal" >

    <!-- Modal content -->
    <div class="modal-content">
      <span class="close">Select Data File</span>

      <select class="form-control" onchange='console.log(value);window.location.hash=value,window.location.reload()'>

        <option selected hidden>-No file selected-</option>
        <option>volcano</option>
        <option>volcano8</option>
        <option>volcano12</option>
        <option>Option four</option>
        <option>Option five</option>
        <option>Option six</option>
        <option>Option seven</option>
        <option>Option eight</option>
      </select>
    </div>

  </div>


  <svg>  </svg>

  <canvas id='canvas'></canvas>


  <div id="graphdiv">
  </div>

  <div class="window">
    <div class="window-content">
      <div class="pane-group">
        <div class="pane-mini sidebar">...</div>
        <div class="pane">...</div>
      </div>
    </div>
  </div>


</body>

<script src="./src/stats.js"></script>

<script>



/// main action script
const electron = require('electron');
const fs = require('fs');
const NetCDFReader = require('netcdfjs');
var ipc = electron.ipcRenderer;
ipc.on('toggle-prefs', (event,arg)=> {console.log(event,arg)});


//parameters - netcdf
window.location.hash = 'volcano12';


</script>
<script src='readnc.js'> </script>


<script>




var svg = d3.select("svg");
svg.style('width', width);
svg.style('height', height);
svg.style("transform", "translate("+window.innerWidth/2.+","+window.innerHeight/2.+")")

window.onresize = function(event) {location.reload()};
window.scrollTo(window.innerWidth/2, window.innerHeight/2);

//d3.select('body').style('background-color', '#222'); // bg colour
//var color = d3.scaleOrdinal(d3.schemeCategory20);
window.color = d3.interpolate("#F6089E", "#3864EB");    //https://github.com/d3/d3-scale
window.color1 = d3.interpolate('#222','blue') ///'blue',"#F6089E");








print(window.nodes)
timestep=21;




const edge_len = window.ncdata.flux.row(timestep)
var concs = window.ncdata.concentration.row(timestep)





window.ncdata.combine.forEach(function(f){

  var prod = f[0];
  var loss = f[1];

  var flx = 0;

  for (i = 0; i < prod.length; i++) {var j = edge_len[prod[i]]; if (isFinite(j)){ flx -= j}};
  for (i = 0; i < loss.length; i++) {var j = edge_len[loss[i]]; if (isFinite(j)){ flx -= j}};


  sign.push(Math.sign(flx));
  flx = Math.log10(Math.abs(flx));
  mylink.push(flx);
  if (isFinite(flx)) dummy.push(flx);

},mylink=[],dummy=[],sign=[]);

//normalize
var min =  d3.min(dummy)
var max =  d3.max(dummy)-min
mylink = mylink.map((d)=>(d-min+1e-6)/max)








// create links object
window.graphlinks =[]
for (i = 0; i < window.ncdata.combine.length; i++) {

  if (sign[i] !== 0) {
    graphlinks.push({"source":window.ncdata.src[i],"target":window.ncdata.tar[i], "v":Number(mylink[i].toFixed(3)), "d":sign[i]}) };
  }

  var concs = window.ncdata.concentration.row(timestep)
  var node_size=[]; dummy = [];
  for (i = 0; i < concs.length; i++){
    var f = concs[i];
    if (f>0) {f = Math.log10(f); dummy.push(f)};
    node_size.push(f);
  }
  //normalize
  var min =  d3.min(dummy);
  var max =  d3.max(dummy)-min;
  node_size = node_size.map((d)=>(d-min+1e-6)/max);




  </script>



  <script src ="./forcegraph.js"></script>

  <script type="text/javascript" src="./src/d3-ForceEdgeBundling.js"></script>
